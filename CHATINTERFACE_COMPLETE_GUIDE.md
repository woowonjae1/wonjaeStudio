# ChatInterface 完整功能列表

## 概述

ChatInterface 是一个功能完整的 AI 聊天界面，集成了所有之前遗失的功能，包括对话历史、模型切换、模型信息、Token 计数和对话统计。

## 核心功能

### 1. 三栏布局

#### 左侧边栏 - 对话历史

- **功能**：保存和管理对话历史
- **显示内容**：
  - 对话标题（自动截取首条对话的前30字符）
  - 对话日期
  - 消息数量统计
- **交互**：点击历史项可加载该对话
- **状态**：无历史时显示提示文本

#### 中间区域 - 消息展示

- **用户消息**：蓝色气泡，右对齐
- **AI 回复**：白色气泡，左对齐
- **AI 头像**：蓝色渐变图标
- **消息信息**：
  - 使用的模型名称
  - Token 计数
  - 时间戳（隐藏显示）
- **功能**：
  - 复制按钮（点击后显示绿色勾选）
  - 自动滚动到最新消息
  - 加载动画显示

#### 右侧边栏 - 对话信息面板

- **模型信息**面板（紫色）
  - 模型名称
  - 提供商
  - 版本号
  - 模型 ID（缩短显示）
- **对话统计**面板（蓝色）
  - 当前轮次
  - 总消息数
  - 用户消息计数
  - AI 回复计数
- **Token 统计**面板（橙色）
  - 本次使用的 tokens
  - 总使用的 tokens
  - 可视化进度条
  - 百分比显示（基于1000 tokens）
- **功能状态**面板（绿色）
  - 实时对话 ✓
  - 网络搜索 (支持启用/禁用)
  - 代码分析 ✓
  - 模型切换 ✓
- **当前模型**面板（靛蓝色）
  - 模型全名
  - 模型描述
  - 完整的模型 ID

### 2. 模型管理

#### 模型选择器

- **位置**：顶部右侧
- **显示**：当前选中的模型名称
- **功能**：下拉选择不同的模型
- **模型列表**：
  - 模型名称和提供商信息
  - 模型描述
  - 当前选中状态指示

#### 模型切换

- **效果**：切换时显示切换消息
- **切换消息内容**：
  - 新模型名称
  - 提供商信息
  - 模型描述
- **状态保持**：切换后继续对话
- **API 传参**：每次请求都传递 `modelId`

#### 可用模型列表

```typescript
const AVAILABLE_MODELS: ModelConfig[] = [
  {
    id: "ep-dvjgwv-1761292043674809878",
    name: "万擎 AI (默认)",
    provider: "Wanqing",
    description: "专业 AI 编程助手",
  },
  // 可以在这里添加更多模型
];
```

### 3. 对话历史管理

#### 自动保存

- **触发**：点击"新对话"按钮时
- **保存内容**：
  - 对话 ID（时间戳）
  - 对话标题（首条消息前30字）
  - 日期（本地化格式）
  - 消息总数

#### 历史加载

- **点击历史项**：加载对应的对话
- **显示消息**：加载成功的提示消息

### 4. 网络搜索集成

#### 搜索开关

- **位置**：输入框上方
- **状态**：可勾选/取消
- **效果**：启用时在发送消息前执行搜索

#### 搜索流程

1. 用户勾选"启用网络搜索"
2. 发送消息
3. 显示搜索加载状态
4. 执行搜索（15秒超时）
5. 显示搜索结果或错误
6. 继续调用 Chat API

#### 搜索错误处理

- **网络错误**：显示错误提示
- **搜索失败**：显示降级提示
- **无结果**：显示无结果提示
- **功能降级**：搜索失败不会中断对话

### 5. Token 计数和统计

#### Token 显示

- **本次使用**：最后一条 AI 回复的 token 数
- **总使用**：整个对话过程的累计 token
- **进度条**：可视化显示使用比例
- **百分比**：相对于 1000 tokens 的百分比

#### 数据来源

- API 响应中的 `tokens` 字段
- 自动累加所有对话的 token 总和
- 每条消息显示该条消息的 token 数

### 6. 对话统计信息

#### 显示内容

- **当前轮次**：从 API 获取的 `conversation.currentTurn`
- **总消息数**：历史对话的消息总数
- **用户消息**：用户发送的消息数
- **AI 回复**：AI 回复的消息数

#### 更新时机

- 每次接收 API 响应时更新
- 显示完整的对话进度

## 消息结构

```typescript
interface Message {
  id: string; // 消息唯一标识
  role: "user" | "assistant"; // 消息角色
  content: string; // 消息内容
  timestamp: Date; // 发送时间
  isStreaming?: boolean; // 是否流式传输中
  tokensUsed?: number; // 该消息使用的 tokens
  model?: string; // 使用的模型名称
}
```

## API 交互

### 请求格式

```json
{
  "message": "用户输入",
  "conversationHistory": [
    { "role": "user", "content": "..." },
    { "role": "assistant", "content": "..." }
  ],
  "enableSearch": true,
  "modelId": "ep-xxxx"
}
```

### 响应格式

```json
{
  "reply": "AI 回复内容",
  "tokens": {
    "prompt": 150,
    "completion": 50,
    "total": 200
  },
  "model": {
    "id": "ep-xxxx",
    "name": "万擎 AI",
    "provider": "Wanqing",
    "version": "1.0"
  },
  "conversation": {
    "currentTurn": 5,
    "totalMessages": 8,
    "userMessages": 4,
    "assistantMessages": 4
  },
  "search": {
    "enabled": true,
    "resultsCount": 3,
    "resultsSources": ["DuckDuckGo"]
  }
}
```

## 状态管理

### 核心状态变量

| 变量                  | 类型                  | 用途                |
| --------------------- | --------------------- | ------------------- |
| `messages`            | Message[]             | 当前对话的所有消息  |
| `input`               | string                | 输入框内容          |
| `loading`             | boolean               | 是否正在加载        |
| `conversationHistory` | ConversationHistory[] | 用于 API 的对话历史 |
| `copiedId`            | string \| null        | 记录哪条消息被复制  |
| `enableSearch`        | boolean               | 是否启用网络搜索    |
| `searching`           | boolean               | 是否正在搜索        |
| `searchError`         | string \| null        | 搜索错误信息        |
| `modelInfo`           | any                   | 当前模型信息        |
| `conversationStats`   | any                   | 对话统计信息        |
| `totalTokensUsed`     | number                | 总 token 使用数     |
| `selectedModel`       | ModelConfig           | 当前选中的模型      |
| `showModelDropdown`   | boolean               | 模型下拉菜单状态    |
| `conversations`       | Array                 | 历史对话列表        |

## 用户交互流程

### 1. 发送消息流程

```
用户输入 → 按Enter → handleSendMessage
  ↓
显示用户消息
  ↓
检查是否启用搜索
  ↓ 是
执行网络搜索
  ↓ 否 / 搜索完成
调用 Chat API（传递 modelId）
  ↓
接收响应
  ↓
更新 modelInfo, conversationStats, totalTokensUsed
  ↓
显示 AI 回复和统计信息
```

### 2. 新建对话流程

```
点击"新对话" → handleNewChat
  ↓
保存当前对话到 conversations 列表
  ↓
清空所有状态
  ↓
显示欢迎消息
```

### 3. 切换模型流程

```
点击模型选择器 → 选择模型 → handleModelChange
  ↓
更新 selectedModel
  ↓
显示模型切换消息
  ↓
继续对话时使用新模型
```

## 样式和主题

### 色彩方案

| 组件       | 颜色      | 用途           |
| ---------- | --------- | -------------- |
| 用户消息   | 蓝色渐变  | 用户输入的消息 |
| AI 消息    | 白色/灰色 | AI 的回复      |
| 模型面板   | 紫色      | 模型信息显示   |
| 统计面板   | 蓝色      | 对话统计显示   |
| Token 面板 | 橙色      | Token 使用统计 |
| 功能面板   | 绿色      | 功能状态显示   |
| 当前模型   | 靛蓝色    | 当前选中模型   |

### 响应式设计

- 三栏布局在大屏幕上正常显示
- 使用 `w-64` 固定侧栏宽度
- 中间区域 `flex-1` 自适应

## 错误处理

### 搜索错误

- 显示红色警告
- 继续允许对话
- 自动降级到本地知识

### API 错误

- 显示错误信息
- 保留操作历史
- 允许重新尝试

### 网络错误

- 显示连接失败提示
- 提示检查网络和配置
- 支持中止操作

## 性能优化

1. **消息滚动**：自动滚动到最新消息
2. **状态更新**：使用函数式更新避免竞态条件
3. **搜索超时**：15秒超时防止长时间挂起
4. **缓存**：搜索结果缓存1小时
5. **条件渲染**：仅在有数据时显示面板

## 扩展建议

### 可以添加的功能

1. **导出对话**：支持 JSON/Markdown 导出
2. **本地存储**：使用 localStorage 持久化对话
3. **文件上传**：支持上传代码和文档
4. **代码高亮**：使用 Prism 或 Highlight.js
5. **深色模式**：切换主题
6. **多语言**：支持多种语言界面

### 可以改进的地方

1. 历史对话的完整加载和恢复
2. 搜索结果的可视化显示
3. 模型参数的调整面板
4. 批量操作对话历史
5. 分享对话链接
